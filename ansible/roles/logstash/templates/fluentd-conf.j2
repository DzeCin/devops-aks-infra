<source>
  @type kafka_group
  brokers {{ broker_servers }}
  consumer_group logstash
  topics {{ topic_id }}
  add_prefix azurek8s
  ssl_ca_certs_from_system true
  username $ConnectionString
  password {{ password }}
  sasl_over_ssl true
  <format>
    @type json
  </format>
</source>

<filter **>
  @type split_array
  split_key records
</filter>

<filter **>
    @type parser
    key_name "$.properties.log"
    hash_value_field "log"
    reserve_data true
    remove_key_name_field true
    <parse>
        @type json
    </parse>
</filter>

<filter **>
  @type record_transformer
  enable_ruby true
  remove_keys UnderlayName,UnderlayClass,tsNs,time,ccpNamespace,operationName
</filter>


<filter **>
    @type flatten_hash
    separator _
    flatten_array false
</filter>

<match **>
  @type loki
  url "#{ENV['LOKI_URL']}"
  username "#{ENV['LOKI_USERNAME']}"
  password "#{ENV['LOKI_PASSWORD']}"
  extra_labels {"env":"dev"}
  flush_interval 10s
  flush_at_shutdown true
  buffer_chunk_limit 1m
  <format>
    @type json
  </format>
</match>